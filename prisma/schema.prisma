generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. USER MODEL (Updated with additional fields)
// ============================================
model User {
  id              String     @id @default(uuid())
  name            String?
  email           String?    @unique
  mobile          String     @unique
  password        String?
  otpCode         String?    @map("otp_code")
  securityPin     String?    @map("security_pin")
  profileImageUrl String?    @map("profile_image_url")
  isAdmin         Boolean    @default(false) @map("is_admin")
  status          UserStatus @default(ACTIVE)
  createdAt       DateTime   @default(now()) @map("created_at")
  lastLogin       DateTime?  @map("last_login")
  phoneAuthEnabled  Boolean  @default(false)

  // Relations
  reviews       Review[]
  reviewReplies ReviewReply[]
  savedShops    SavedShop[]
  transactions  Transaction[]
  payouts       Payout[]
  reports       Report[]
  settings      Setting?
  searchHistory SearchHistory[]
  addresses Address[]

  @@map("users")
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

model SearchHistory {
  id         String   @id @default(uuid())
  userId     String
  query      String
  targetId   String?
  targetName String?
  targetType String?
  latitude   Float?    // NEW
  longitude  Float?    // NEW
  searchedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([searchedAt])
}

model Address {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  label           String   // "Home", "Work", "Other"
  customLabel     String?  @map("custom_label") // if label is "Other"
  addressLine1    String   @map("address_line1")
  addressLine2    String?  @map("address_line2")
  landmark        String?
  city            String
  state           String?
  pincode         String?
  country         String   @default("India")
  latitude        Float
  longitude       Float
  isDefault       Boolean  @default(false) @map("is_default")
  deliveryInstructions String? @map("delivery_instructions")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

// ============================================
// 18. SUGGESTIONS MODULE
// ============================================

model SuggestionSection {
  id             String   @id @default(uuid())
  title          String
  subtitle       String?
  imageUrl       String?  @map("image_url")
  type           SuggestionType
  mainCategoryId String?  @map("main_category_id")
  config         Json?
  sortOrder      Int      @default(0) @map("sort_order")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  mainCategory MainCategory?    @relation(fields: [mainCategoryId], references: [id], onDelete: SetNull)
  items        SuggestionItem[]

  @@map("suggestion_sections")
  @@index([type])
  @@index([isActive, sortOrder])
}

enum SuggestionType {
  NEAR_ME
  QUICK_SNACK
  CATEGORY_SHOPS
  CUSTOM
}

model SuggestionItem {
  id             String   @id @default(uuid())
  sectionId      String   @map("section_id")
  title          String
  subtitle       String?
  imageUrl       String?  @map("image_url")
  shopId         String?  @map("shop_id")
  mainCategoryId String?  @map("main_category_id")
  sortOrder      Int      @default(0) @map("sort_order")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  section      SuggestionSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  shop         Shop?             @relation(fields: [shopId], references: [id], onDelete: SetNull)
  mainCategory MainCategory?     @relation(fields: [mainCategoryId], references: [id], onDelete: SetNull)

  @@map("suggestion_items")
  @@index([sectionId])
}


model QuickSnackCategory {
  id        String   @id @default(uuid())
  name      String   @unique  // e.g., "Pizza", "Burger"
  iconUrl   String?  // URL to category icon
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
// ============================================
// 2. MAIN CATEGORY
// ============================================
model MainCategory {
  id        String   @id @default(uuid())
  name      String   @map("category_name")
  imageUrl  String?  @map("image_url")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  shops   Shop[]
  banners CategoryBanner[]
  suggestionSections SuggestionSection[]  // ← ADD THIS
  suggestionItems    SuggestionItem[]     // ← ADD THIS
  appUiConfigs       AppUiConfig[]        // ← ADD THIS LINE

  @@map("main_categories")
}

// ============================================
// 3. SHOP
// ============================================
model Shop {
  id          String   @id @default(uuid())
  categoryId  String   @map("category_id")
  name        String
  logoUrl     String?  @map("logo_url")
  description String?
  reviewDescription String?  @map("review_description")  // New field for review summary
  address     String?
  city        String?
  latitude    Float?
  longitude   Float?
  phoneNumber String?  @map("phone_number")
  websiteUrl  String?  @map("website_url")
  chatLink    String?  @map("chat_link")
  openHours   String?  @map("open_hours")
  avgRating   Float?   @default(0)
  reviewCount Int      @default(0) @map("review_count")
  createdAt   DateTime @default(now()) @map("created_at")
  isActive        Boolean  @default(true)

  // Relations
  category  MainCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  images    ShopImage[]
  offers    ShopOffer[]
  amenities ShopAmenity[]
  menus     Menu[]
  reviews   Review[]
  savedBy   SavedShop[]
  qrCodes   QRCode[]
  suggestionItems SuggestionItem[] // ← ADD THIS
  compareItems CompareItem[]    // <-- add this line
  @@map("shops")
}

// ============================================
// 4. SHOP IMAGES
// ============================================
model ShopImage {
  id        String  @id @default(uuid())
  shopId    String  @map("shop_id")
  imageUrl  String  @map("image_url")
  isPrimary Boolean @default(false) @map("is_primary")

  // Relations
  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("shop_images")
}

// ============================================
// 5. SHOP OFFERS
// ============================================
model ShopOffer {
  id          String    @id @default(uuid())
  shopId      String    @map("shop_id")
  title       String
  description String?
  validFrom   DateTime? @map("valid_from")
  validTo     DateTime? @map("valid_to")
  terms       String?
  isActive    Boolean   @default(true) @map("is_active")

  // Relations
  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("shop_offers")
}

// ============================================
// 6. SHOP AMENITIES
// ============================================
model ShopAmenity {
  id          String  @id @default(uuid())
  shopId      String  @map("shop_id")
  name        String
  icon        String?
  isAvailable Boolean @default(true) @map("is_available")

  // Relations
  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("shop_amenities")
}

// ============================================
// 7. MENU
// ============================================
model Menu {
  id           String  @id @default(uuid())
  shopId       String  @map("shop_id")
  itemName     String  @map("item_name")
  description  String?
  price        Float
  quantity     Int?     // New optional field for piece count per set
  imageUrl     String? @map("image_url")
  categoryName String? @map("category_name")
  isAvailable  Boolean @default(true) @map("is_available")
  // NEW:
  isQuickSnack Boolean  @default(false)

  // Relations
  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@map("menus")
}

model AppConfig {
  id    String @id @default(uuid())
  key   String @unique
  value String

  @@map("app_config")
}
// ============================================
// 8. REVIEW TAGS
// ============================================
model ReviewTag {
  id          String  @id @default(uuid())
  tagName     String  @unique @map("tag_name")
  description String?

  // Relations
  reviewLinks ReviewTagLink[]

  @@map("review_tags")
}

// ============================================
// 9. REVIEWS
// ============================================
model Review {
  id        String   @id @default(uuid())
  shopId    String   @map("shop_id")
  userId    String   @map("user_id")
  rating    Int
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  shop    Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags    ReviewTagLink[]
  replies ReviewReply[]

  @@map("reviews")
}

// ============================================
// 10. REVIEW TAG LINKS (Many-to-Many)
// ============================================
model ReviewTagLink {
  id       String @id @default(uuid())
  reviewId String @map("review_id")
  tagId    String @map("tag_id")

  // Relations
  review Review    @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  tag    ReviewTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([reviewId, tagId])
  @@map("review_tag_links")
}

// ============================================
// 11. REVIEW REPLIES (Admin Only)
// ============================================
model ReviewReply {
  id        String   @id @default(uuid())
  reviewId  String   @map("review_id")
  adminId   String   @map("admin_id")
  message   String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  admin  User   @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("review_replies")
}

// ============================================
// 12. SAVED SHOPS (User Favorites)
// ============================================
model SavedShop {
  id      String   @id @default(uuid())
  userId  String   @map("user_id")
  shopId  String   @map("shop_id")
  savedAt DateTime @default(now()) @map("saved_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([userId, shopId])
  @@map("saved_shops")
}

// ============================================
// 13. TRANSACTIONS
// ============================================
model Transaction {
  id          String            @id @default(uuid())
  userId      String            @map("user_id")
  txnType     TransactionType   @map("txn_type")
  source      TransactionSource
  amount      Float
  description String?
  status      TransactionStatus @default(PENDING)
  createdAt   DateTime          @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum TransactionSource {
  WALLET
  QR_SCAN
  PAYOUT
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

// ============================================
// 14. PAYOUTS
// ============================================
model Payout {
  id            String        @id @default(uuid())
  userId        String        @map("user_id")
  requestDate   DateTime      @default(now()) @map("request_date")
  payoutDate    DateTime?     @map("payout_date")
  amount        Float
  paymentMethod PaymentMethod @map("payment_method")
  status        PayoutStatus  @default(PENDING)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payouts")
}

enum PaymentMethod {
  BANK
  UPI
  WALLET
}

enum PayoutStatus {
  PENDING
  PROCESSED
  FAILED
}

// ============================================
// 15. REPORTS
// ============================================
model Report {
  id             String   @id @default(uuid())
  userId         String   @unique @map("user_id")
  totalEarned    Float    @default(0)
  totalSpent     Float    @default(0)
  monthlySummary Json?    @map("monthly_summary")
  lastUpdated    DateTime @default(now()) @updatedAt @map("last_updated")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reports")
}

model CategoryBanner {
  id             String   @id @default(uuid())
  mainCategoryId String   @map("main_category_id")
  imageUrl       String   @map("image_url")
  title          String? // optional banner title
  linkUrl        String? // optional link when banner clicked
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  mainCategory MainCategory @relation(fields: [mainCategoryId], references: [id], onDelete: Cascade)

  @@map("category_banners")
}

// ============================================
// 16. QR CODES
// ============================================
model QRCode {
  id          String   @id @default(uuid())
  linkedShop  String?  @map("linked_shop")
  qrType      QRType   @map("qr_type")
  data        String
  generatedAt DateTime @default(now()) @map("generated_at")

  // Relations
  shop Shop? @relation(fields: [linkedShop], references: [id], onDelete: SetNull)

  @@map("qr_codes")
}

enum QRType {
  PAYMENT
  INFO
  REFERRAL
}

// ============================================
// 17. SETTINGS
// ============================================
model Setting {
  id                   String   @id @default(uuid())
  userId               String   @unique @map("user_id")
  notificationsEnabled Boolean  @default(true) @map("notifications_enabled")
  darkMode             Boolean  @default(false) @map("dark_mode")
  appLanguage          String   @default("en") @map("app_language")
  createdAt            DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("settings")
}

// ========================================
// CONFIGURATION SYSTEM - ENUMS
// ========================================

enum ScreenName {
  LANDING_PAGE
  SUGGESTIONS
  NEAR_ME
}

enum ComponentType {
  SECTION      // Main sections like "Locate", "Suggestions", "Review"
  CHIP         // Category chips like "Food & Beverage", "Fashion"
  BANNER       // Promotional banners
}

enum BehaviourType {
  STATIC           // Just display, no special logic
  NEAR_ME          // Show nearby shops based on location
  QUICK_SNACK      // Show quick snack menu items
  CATEGORY_BASED   // Show shops from a specific MainCategory
  CUSTOM_QUERY     // Custom search query
}

// ========================================
// MAIN CONFIGURATION TABLE
// ========================================

model AppUiConfig {
  id            String         @id @default(uuid())
  screenName    ScreenName     @map("screen_name")
  componentType ComponentType  @map("component_type")
  componentName String         @map("component_name")  // "Locate", "Food & Beverages", "Banner-1"
  behaviour     BehaviourType  @default(STATIC)
  
  // Visual assets
  iconUrl       String?        @map("icon_url")
  imageUrl      String?        @map("image_url")
  
  // Location-specific (for NearME banners/chips)
  location      String?        // "Chennai", "Coimbatore", "Madurai"
  
  // Link to MainCategory (for category-based behaviour)
  mainCategoryId String?       @map("main_category_id")
  
  // Configuration options (JSON for flexibility)
  config        Json?          // { radiusKm: 7, maxItems: 10, query: "...", etc. }
  
  // Control
  isActive      Boolean        @default(true) @map("is_active")
  sortOrder     Int            @default(0) @map("sort_order")
  
  // Timestamps
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  // Relations
  mainCategory  MainCategory?  @relation(fields: [mainCategoryId], references: [id], onDelete: SetNull)

  @@map("app_ui_config")
  @@index([screenName, componentType, isActive])
  @@index([location])
  @@index([sortOrder])
  @@index([mainCategoryId])
}

model CompareList {
  id        String       @id @default(uuid())
  userId    String?                      // nullable for anonymous users
  sessionId String?                      // nullable (use a cookie/session token for anon)
  createdAt DateTime     @default(now())
  items     CompareItem[]
}

model CompareItem {
  id         String   @id @default(uuid())
  compareId  String
  shopId     String
  addedAt    DateTime @default(now())

  compare    CompareList @relation(fields: [compareId], references: [id], onDelete: Cascade)
  shop       Shop        @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([compareId, shopId])
}
